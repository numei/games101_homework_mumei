# [透视投影矩阵](https://zhida.zhihu.com/search?content_id=201443885&content_type=Article&match_order=1&q=%E9%80%8F%E8%A7%86%E6%8A%95%E5%BD%B1%E7%9F%A9%E9%98%B5&zhida_source=entity)的Z-near,Z-far

https://zhuanlan.zhihu.com/p/509902950

# 透视校正插值（Perspective Correct Interpolation)

## 1. 设定初始状态与参数

假设在 3D 观察空间（相机空间）中有一条线段，其两个端点为 **$P_1(X_1, Z_1)$** 和 **$P_2(X_2, Z_2)$**。

在这条线段上有一个点 **$P_t(X_t, Z_t)$**，它由 3D 空间的参数 **$t \in [0, 1]$** 线性插值决定：

$$
X_t = X_1 + t(X_2 - X_1) = (1-t)X_1 + tX_2
$$

$$
Z_t = Z_1 + t(Z_2 - Z_1) = (1-t)Z_1 + tZ_2
$$

假设投影平面距离相机原点的距离为 **$d$**。根据相似三角形原理，3D 点 **$P(X, Z)$** 投影到屏幕上的 1D 坐标 **$x$** 为：

$$
x = \frac{X \cdot d}{Z}
$$

因此，端点和插值点在屏幕上的坐标分别为：

$$
x_1 = \frac{X_1 d}{Z_1}, \quad x_2 = \frac{X_2 d}{Z_2}, \quad x_t = \frac{X_t d}{Z_t}
$$

---

## 2. 引入屏幕空间的插值参数 **$s$**

在光栅化阶段（遍历屏幕像素时），我们是以**屏幕坐标**为基准进行线性插值的。

假设在屏幕上，点 **$x_t$** 位于 **$x_1$** 和 **$x_2$** 之间，对应的屏幕空间插值参数为 **$s \in [0, 1]$**。

所以屏幕上的坐标也可以表示为：

$$
x_t = (1-s)x_1 + s x_2
$$

**我们的目标是：找出 3D 空间参数 **$t$** 与屏幕空间参数 **$s$** 之间的关系。**

根据 **$x_t$** 的定义，我们可以列出等式：

$$
\frac{X_t d}{Z_t} = (1-s)\frac{X_1 d}{Z_1} + s \frac{X_2 d}{Z_2}
$$

约掉两边的常数 **$d$**，并将左边的 **$X_t$** 和 **$Z_t$** 展开：

$$
\frac{(1-t)X_1 + tX_2}{(1-t)Z_1 + tZ_2} = \frac{(1-s)X_1}{Z_1} + \frac{s X_2}{Z_2}
$$

为了解出 **$s$** 关于 **$t$** 的表达式，我们可以通过代数化简（过程略去中间繁琐的通分，直接给出结果）：

$$
s = \frac{t Z_1}{Z_t}
$$

_(注意：这里的分子分母取决于你设定的起点，通常推导出的对称形式如下)_

更标准的解法是直接计算距离比例 **$s = \frac{x_t - x_1}{x_2 - x_1}$**，代入坐标后可得：

$$
s = \frac{t Z_2}{Z_1 + t(Z_2 - Z_1)}
$$

将其反解，求出 **$t$** 关于 **$s$** 的表达式（这是见证奇迹的时刻）：

$$
t = \frac{s Z_1}{(1-s)Z_2 + s Z_1}
$$

**结论 1** ：**$t$** 和 **$s$** 并不是相等的（除非 **$Z_1 = Z_2$**，即线段平行于屏幕）。这就是为什么直接在屏幕上用参数 **$s$** 盲目插值 3D 属性会出错的原因。

---

## 3. 证明 **$1/Z$** 在屏幕空间是线性的

现在，我们要看看 3D 空间的深度 **$Z_t$** 的倒数，也就是 **$\frac{1}{Z_t}$**，在屏幕空间（也就是关于参数 **$s$**）是什么样子。

把前面求出的 **$t$** 代入 **$Z_t$** 的公式：

$$
Z_t = Z_1 + t(Z_2 - Z_1)
$$

$$
Z_t = Z_1 + \frac{s Z_1 (Z_2 - Z_1)}{(1-s)Z_2 + s Z_1}
$$

通分化简：

$$
Z_t = \frac{Z_1 [ (1-s)Z_2 + s Z_1 ] + s Z_1 Z_2 - s Z_1^2}{(1-s)Z_2 + s Z_1}
$$

$$
Z_t = \frac{Z_1 Z_2 - s Z_1 Z_2 + s Z_1^2 + s Z_1 Z_2 - s Z_1^2}{(1-s)Z_2 + s Z_1}
$$

$$
Z_t = \frac{Z_1 Z_2}{(1-s)Z_2 + s Z_1}
$$

现在，对等式两边同时 **取倒数** ：

$$
\frac{1}{Z_t} = \frac{(1-s)Z_2 + s Z_1}{Z_1 Z_2}
$$

$$
\frac{1}{Z_t} = \frac{(1-s)Z_2}{Z_1 Z_2} + \frac{s Z_1}{Z_1 Z_2}
$$

$$
\frac{1}{Z_t} = (1-s)\frac{1}{Z_1} + s\frac{1}{Z_2}
$$

**证明完毕！** 看这个公式的形式，它是一个完美的线性插值方程！这说明：**在屏幕空间中，利用像素的重心坐标（即参数 **$s$**）去插值顶点的 **$1/Z$**，可以得到绝对准确的当前像素点的 **$1/Z_t$**。**

在齐次坐标系中，顶点坐标 **$(X, Y, Z, 1)$** 乘以投影矩阵后，**$W$** 分量通常存储的就是原来的 **$Z$**（或 **$-Z$**），这就是为什么你的代码里写的是 `1.0 / (alpha / v[0].w() + ...)`。

---

## 4. 证明“属性/Z”在屏幕空间也是线性的

假设顶点有一个属性 **$I$**（比如纹理坐标 UV，或者颜色），在 3D 空间中是线性变化的：

$$
I_t = (1-t)I_1 + t I_2
$$

我们再把 **$t = \frac{s Z_1}{(1-s)Z_2 + s Z_1}$** 代进去：

$$
I_t = (1 - \frac{s Z_1}{(1-s)Z_2 + s Z_1})I_1 + \frac{s Z_1}{(1-s)Z_2 + s Z_1}I_2
$$

$$
I_t = \frac{(1-s)Z_2}{(1-s)Z_2 + s Z_1}I_1 + \frac{s Z_1}{(1-s)Z_2 + s Z_1}I_2
$$

将分子分母同除以 **$Z_1 Z_2$**：

$$
I_t = \frac{(1-s)\frac{I_1}{Z_1} + s\frac{I_2}{Z_2}}{\frac{1-s}{Z_1} + \frac{s}{Z_2}}
$$

**这个终极公式解释了你代码中的所有操作：**

1. 分母部分：**$\frac{1-s}{Z_1} + \frac{s}{Z_2}$**，这就是你在代码里求的 `w_reciprocal` 的倒数。
2. 分子部分：**$(1-s)\frac{I_1}{Z_1} + s\frac{I_2}{Z_2}$**，这说明**属性除以深度（**$I/Z$**）**在屏幕空间也是完美线性的。这就是你代码里用重心坐标去乘以 `v[i].z() / v[i].w()` 的原因（在你的代码里，被插值的属性刚好是投影后的 **$Z$** 值本身）。
3. 最终结果：为了得到真正的 **$I_t$**，你需要把插值出来的“分子”除以插值出来的“分母”（或者乘以分母的倒数 `w_reciprocal`）。
